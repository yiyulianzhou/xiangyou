<include file="Public/head"/>
<body class="no-skin">
    <div class="main-content">
        <div class="main-content-inner">
            <!-- #section:basics/content.breadcrumbs -->
   
            <!-- /section:basics/content.breadcrumbs -->
            <div class="page-content">
                <style>
                    .grouptd {
                        position: relative;
                    }

                    .group {
                        display: inline-block;
                        width: 100%;
                    }

                    .groupselect {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        border: 0;
                    }
                </style>
                <!-- /section:settings.box -->
                <div class="space-4"></div>
                <div class="row">
                    <input type="hidden" name="beginTime" id="beginTime" value="" />
                    <input type="hidden" name="endTime" id="endTime" value="" />
                    <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered table-hover"
                           id="pos_apply">

                        <thead id="pos_apply_data_table_thead">
                        </thead>
                        <tbody id="pos_apply_data_table_tbody">

                        </tbody>

                        </thead>
                    </table>
                </div>
                <div class="modal inmodal" id="myModal" tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content animated bounceInRight">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                <h4 class="modal-title">未通过原因</h4>
                                <small class="font-bold">该用户的余额提现未通过请填写原因</small>
                            </div>
                            <div class="modal-body">
                                <input type="text" placeholder="输入未通过原因" class="form-control" value="" id="reason"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary" id="sub">提交</button>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /.row -->
    </div><!-- /.page-content -->
</div>
</div><!-- /.main-content -->

</div><!-- /.main-container -->

<include file="Public/footerjs"/>
<!-- inline scripts related to this page -->
<script type="text/javascript">
    $(function () {
        var table;
        var start_date;
        var start_end ;
        var where;
        GetPosApply('all')
        $(".group").click(function () {
            $(this).addClass('hide');
            $(this).parent().find(".groupselect").removeClass('hide');
        })
        $(".groupselect").on("change", function () {
            var ob = $(this);
            var gid = ob.val();
            var uid = ob.parent().find('.group').attr('val');
            $.get("{:U('update')}?ajax=yes&uid=" + uid + "&gid=" + gid, function (data) {
                var text = ob.find("option:selected").text();
                ob.parent().find(".group").removeClass('hide').html(text);
                ob.addClass('hide');
            });
        })

        $(".check-all").click(function () {
            $(".uids").prop("checked", this.checked);
        });
        $(".uids").click(function () {
            var option = $(".ids");
            option.each(function (i) {
                if (!this.checked) {
                    $(".check-all").prop("checked", false);
                    return false;
                } else {
                    $(".check-all").prop("checked", true);
                }
            });
        });
        $("#submit").click(function () {
            bootbox.confirm({
                title: "系统提示",
                message: "是否要删除所选用户？",
                callback: function (result) {
                    if (result) {
                        $("#form").submit();
                    }
                },
                buttons: {
                    "cancel": {"label": "取消"},
                    "confirm": {
                        "label": "确定",
                        "className": "btn-danger"
                    }
                }
            });
        });
        $(".del").click(function () {
            var url = $(this).attr('val');
            bootbox.confirm({
                title: "系统提示",
                message: "是否要删除该条申请?",
                callback: function (result) {
                    if (result) {
                        window.location.href = url;
                    }
                },
                buttons: {
                    "cancel": {"label": "取消"},
                    "confirm": {
                        "label": "确定",
                        "className": "btn-danger"
                    }
                }
            });
        });

        $(".pass").click(function () {
            var url = $(this).attr('val');
            bootbox.confirm({
                title: "系统提示",
                message: "通过审核吗?",
                callback: function (result) {
                    if (result) {
                        window.location.href = url;
                    }
                },
                buttons: {
                    "cancel": {"label": "取消"},
                    "confirm": {
                        "label": "确定",
                        "className": "btn-danger"
                    }
                }
            });
        });

        $(".nopass").click(function () {
            var url = $(this).attr('val');
            bootbox.confirm({
                title: "系统提示",
                message: "不通过审核吗?",
                callback: function (result) {
                    if (result) {
                        window.location.href = url;
                    }
                },
                buttons: {
                    "cancel": {"label": "取消"},
                    "confirm": {
                        "label": "确定",
                        "className": "btn-danger"
                    }
                }
            });
        });
    })

    function GetPosApply(date){
        if ($('#pos_apply').hasClass('dataTable')) {
            table = $('#pos_apply').dataTable();
            table.fnClearTable(); //清空一下table
            table.fnDestroy(); //还原初始化了的datatable
        }
        $.ajax({
            //提交数据的类型 POST GET
            type:"post",
            //提交的网址
            url:"{:U('AmountBack')}",
            data:{date:date},
            //提交的数据
            //返回数据格式
            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".
            //在请求之前调用的函数
            beforeSend:function(){$("#msg").html("logining");},
            //成功返回之后调用的函数
            success:function(data){
                //初始化内容
                $("#pos_apply_data_table_thead").html('');
                $("#pos_apply_data_table_tbody").html('');
                var title = '';
                title += '<tr><th>昵称</th><th>手机号</th><th>提现金额</th><?php if(!isset($user['parent_id'])): ?><th>审核操作</th><?php endif; ?><th>用户等级</th><th>申请时间</th><th>更新时间</th><?php if(!isset($user['parent_id'])): ?><th>操作</th><?php endif; ?></tr>'
                if(data.code == 200)
                {
                    var sex
                    var html = '';
                    for (var i = 0; i < data.list.length; i++) {
                        html += '<tr><td>'+data.list[i]['nickname']+'</td>'
                                + '<td>'+data.list[i]['phone']+'</td>'
                                + '<td>'+data.list[i]['amount']+'</td>'
                        <?php if(!isset($user['parent_id'])): ?>
                        if(data.list[i]['status']== 0 ){
                            html+= '<td  id="allow'+data.list[i]['id']+'"><a onclick="pay('+data.list[i].id+')">已打款 </a>&nbsp|&nbsp<a onclick="refuse('+data.list[i].id+')">拒绝通过</a></td>'
                        }
                        if(data.list[i]['status']== 1 ){
                            html+= '<td><div>已完成 </div></td>'
                        }
                        if(data.list[i]['status']== 2 ){
                            html+= '<td><div title="'+data.list[i]['reason']+'">未通过</div></td>'
                        }
                        <?php endif; ?>
                        html += '<td>'+data.list[i]['isAgent']+'</td>'
                                + '<td>'+data.list[i]['create_time']+'</td>'
                                + '<td>'+data.list[i]['update_time']+'</td>'
                                <?php if(!isset($user['parent_id'])): ?>
                                +'<td><a onclick="refuse('+data.list[i].id+')">重写拒绝原因</a>&nbsp'
                                +'|&nbsp<a href="delamount?id='+data.list[i].id+'">删除</a></td>'
                                <?php endif; ?>
                    }
                    $("#pos_apply_data_table_thead").html(title);
                    $("#pos_apply_data_table_tbody").html(html);
                    //配置Datatable
                    DatatableConfig('pos_apply','5');
                    $(".buttons-excel").css('color','#1EB395');
                    $(".buttons-excel").css('background','none');
                    $(".buttons-excel").css('border','0');
                    $(".buttons-excel").css('font-size','18px');
                    $(".buttons-excel").css('margin-top','-10px');
                    $(".buttons-excel").css('margin-bottom','0px');
                    $(".buttons-excel").css('margin-left','-200px');
                    $(".buttons-excel").html('导出到Excel');
                    $("#reportrange").css('margin-top','3px');
                    $("#reportrange").css('margin-left','50px');
                    $("#pos_apply_length").css('margin-left','50px');

                }else{
                    alert('暂无提现申请记录');
                    $("#pos_apply_data_table_thead").html(title);
                }
            }   ,
            //调用出错执行的函数
            error: function(){
                //请求出错处理
                alert('加载页面图表数据出错');
            }
        });
    }
    function initComplete(data) {
        var dataPlugin =
                '<div id="reportrange" class="pull-left dateRange" style="width:400px;margin-left: 10px"> '+
                '日期：<i class="glyphicon glyphicon-calendar fa fa-calendar"></i> '+
                '<span id="searchDateRange"></span>  '+
                '<b class="caret"></b></div> ';
        $('#mytoolbox').append(dataPlugin);
        //时间插件

        $('#reportrange span').html('请选择时间');
        //配置DateRangePicker
        DaterangepickerConfig('reportrange');

        $(".daterangepicker").find("li").each(function (){
            if($(this).hasClass("active")){
                $(this).removeClass("active");
            }
            if(dateOption==$(this).html()){
                $(this).addClass("active");
            }
        });

        //选择时间后触发重新加载的方法
        $("#reportrange").on('apply.daterangepicker',function(){
            start_date = $('#beginTime').val()
            start_end = $('#endTime').val();
            where = start_date + ','+start_end;
            GetPosApply(where);

        });
    }
    function pay(id){
        var td_id = $('#allow'+id);
        $.ajax({
            //提交数据的类型 POST GET
            type:"post",
            //提交的网址
            url:"{:U('bankPass')}",
            data:{id:id},
            //提交的数据
            //返回数据格式
            datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".
            //在请求之前调用的函数
            beforeSend:function(){$("#msg").html("logining");},
            //成功返回之后调用的函数
            success:function(data){
                if(data.code == 200)
                {
                    td_id.html('已通过');
                }else{
                    alert(data.msg);
                }
            }   ,
            //调用出错执行的函数
            error: function(){
                //请求出错处理
                alert('加载页面图表数据出错');
            }
        });
    }

    function refuse(id){
        $('#myModal').modal('show');
        $('#sub').unbind('click').bind('click',function(){
            if($('#reason').val().length<=0){
                alert('请输入拒绝审核通过的原因');
                return;
            }

            var reason = $('#reason').val();
            var td_id = $('#allow'+id);
            $.ajax({
                //提交数据的类型 POST GET
                type:"get",
                //提交的网址
                url:"{:U('Noback')}",
                data:{id:id,reason:reason},
                //提交的数据
                //返回数据格式
                datatype: "json",//"xml", "html", "script", "json", "jsonp", "text".
                //在请求之前调用的函数
                beforeSend:function(){$("#msg").html("logining");},
                //成功返回之后调用的函数
                success:function(data){
                    if(data.code == 200)
                    {
                        $('#myModal').modal('hide');
                        td_id.html(data.msg);

                    }else{
                        alert(data.msg);
                    }
                }   ,
                //调用出错执行的函数
                error: function(){
                    //请求出错处理
                    alert('加载页面图表数据出错');
                }
            });
        });
    }
</script>
</body>
</html>
